name: Benchmark

on:
  workflow_dispatch:  # Only manual trigger, not automatic
  # Disabled automatic triggers until Flutter test environment is available
  # push:
  #   paths:
  #     - 'lib/**'
  #     - 'tool/benchmark.dart'
  #     - '.github/workflows/benchmark.yml'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'
          channel: 'stable'

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Download Test Model
        run: flutter pub run tool/setup_on_device_test.dart

      - name: Run Benchmark
        run: flutter pub run tool/benchmark.dart

      - name: Create Pull Request with Results
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update benchmark report"
          title: "ðŸ“Š Benchmark Results Update"
          body: |
            Automated benchmark run results.

            See `BENCHMARK_REPORT.md` for details.
          branch: "benchmark-results"
          base: "main"
          delete-branch: true
          add-paths: |
            BENCHMARK_REPORT.md
