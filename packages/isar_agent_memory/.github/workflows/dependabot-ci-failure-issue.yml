name: Dependabot CI failure issue

on:
  workflow_run:
    workflows: ["Flutter CI"]
    types: [completed]

jobs:
  create-issue-on-failure:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Create issue for failed Dependabot PR
        uses: actions/github-script@v7
        with:
          script: |
            const wr = context.payload.workflow_run;
            const { owner, repo } = context.repo;
            const runId = wr.id;
            // Fetch associated PRs for this workflow run
            const prsResp = await github.rest.actions.listWorkflowRunPullRequests({
              owner,
              repo,
              run_id: runId,
              per_page: 1,
            });
            if (!prsResp.data.pull_requests || prsResp.data.pull_requests.length === 0) {
              core.info('No PRs asociados al workflow run. Nada que hacer.');
              return;
            }
            const pr = prsResp.data.pull_requests[0];
            if (!pr.user || pr.user.login !== 'dependabot[bot]') {
              core.info('El PR asociado no es de Dependabot. Nada que hacer.');
              return;
            }
            const title = `CI falló en PR de Dependabot #${pr.number}`;
            const body = [
              `El CI falló para el PR de Dependabot: #${pr.number} (${pr.title}).`,
              '',
              `Autor: ${pr.user.login}`,
              `Branch: ${pr.head.ref} → ${pr.base.ref}`,
              '',
              `Enlace al PR: ${pr.html_url}`,
              `Ejecución del workflow: ${wr.html_url}`,
              '',
              'Acciones sugeridas:',
              '- Revisar logs del job fallido.',
              '- Si el fallo es por breaking changes, crear commit de refactor en la misma rama o abrir PR de refactor.',
              '- Considerar ajustar constraints en pubspec.yaml o aplicar migraciones necesarias.',
            ].join('\n');
            await github.rest.issues.create({
              owner,
              repo,
              title,
              body,
              labels: ['dependencies', 'ci', 'refactor-needed']
            });
