# Auto Deploy - Deploy documentation and track deployment status
# Creates issues if deployment fails

name: ðŸš€ Auto Deploy

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    name: ðŸ“š Build Documentation
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.build.outcome }}
      error_log: ${{ steps.capture-errors.outputs.errors }}

    steps:
      - name: ðŸ“‹ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ”¨ Build documentation site
        id: build
        continue-on-error: true
        run: |
          mkdir -p _site

          # Copy docs
          cp -r docs/* _site/ 2>&1 | tee build-errors.log || true
          cp README.md _site/index.md 2>&1 | tee -a build-errors.log || true

          # Create index
          cat > _site/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>OrionHealth Documentation</title>
            <meta http-equiv="refresh" content="0; url=./README.html">
          </head>
          <body>
            <p>Redirecting to documentation...</p>
          </body>
          </html>
          EOF

          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Capture errors
        id: capture-errors
        if: steps.build.outcome == 'failure'
        run: |
          {
            echo "errors<<EOF"
            echo "## ðŸ“š Documentation Build Errors"
            echo ""
            echo '```'
            cat build-errors.log
            echo '```'
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  deploy:
    name: ðŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: needs.build-docs.outputs.status == 'success'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment success
        run: |
          echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY

  handle-failure:
    name: ðŸš¨ Handle Deployment Failure
    runs-on: ubuntu-latest
    needs: build-docs
    if: needs.build-docs.outputs.status == 'failure'

    steps:
      - name: ðŸ“‹ Checkout
        uses: actions/checkout@v4

      - name: ðŸš¨ Create deployment failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ERRORS: ${{ needs.build-docs.outputs.error_log }}
        run: |
          ISSUE_TITLE="ðŸš€ Deployment Failed - $(date +%Y-%m-%d)"

          ISSUE_BODY=$(cat <<EOF
          ## ðŸš¨ Automated Issue: Deployment Failure

          **Detected by:** Auto Deploy Workflow
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---

          ### Error Details

          $ERRORS

          ---

          ### ðŸ¤– Agent Assignment

          This issue requires immediate attention as it blocks documentation deployment.

          **Recommended Agent:** Jules (infrastructure/deployment issues)

          ### ðŸ“‹ Tasks

          - [ ] Review deployment logs
          - [ ] Fix build errors
          - [ ] Verify docs structure
          - [ ] Test locally with \`gh-pages\` or similar
          - [ ] Commit fixes

          ### ðŸ”§ Debug Commands

          \`\`\`bash
          # Test docs build locally
          mkdir -p _site
          cp -r docs/* _site/

          # Serve locally
          cd _site
          python3 -m http.server 8000
          # Visit http://localhost:8000
          \`\`\`

          ---

          **Auto-generated by:** Auto Deploy Workflow
          **Priority:** ðŸ”´ HIGH (blocks documentation)
          EOF
          )

          gh issue create \
            --title "$ISSUE_TITLE" \
            --body "$ISSUE_BODY" \
            --label "ai-agent,bug,deployment,priority-high" \
            --assignee ""

          echo "âœ… Created deployment failure issue"

      - name: ðŸŽ¯ Trigger agent dispatcher
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 3
          gh workflow run agent-dispatcher.yml \
            --field strategy="jules-only" \
            --field max_issues="1" \
            --field label_filter="ai-agent"
